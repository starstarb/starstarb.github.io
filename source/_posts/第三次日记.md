---
title: 第三次日记
categories: 日记
tags: dairy
abbrlink: c9647612
date: 2019-07-06 22:27:55
password: 753159
message: Welcome to my blog, enter password to read.  
abstract: Welcome to my blog, enter password to read.  
---
![](https://github.com/starstarb/clouding/raw/master/head/72517f966e2b58366e8bba7608a61092.jpg)
<!--more-->
hexo d提交出现连接22端口错误的问题，以前还好好的，改了改主题配置，加了个评论和其他功能，突然就这样了，搞了半天都没解决，好难受.jpg。
远程库连不上了，试了很多方法都不行，真的头大。。。。
休息一会再写。

按照百度方法，添加config文件：
```
Host github.com
User 230326401@qq.com
Hostname ssh.github.com
PreferredAuthentications publickey
IdentityFile ~/.ssh/id_rsa
Port 443

```
但是，一直出现
```
$ ssh -T git@github.com
Connection reset by 192.30.253.122 port 443
```
找了很多解决办法，均无效，已崩溃。。。


决定学习ssh相关知识

继续修改，觉得应该对ssh进行调试，ssh -v debug 发现问题，
````
$ ssh -v debug
OpenSSH_7.9p1, OpenSSL 1.1.1a  20 Nov 2018
debug1: Reading configuration data /c/Users/PC_2017/.ssh/config
debug1: Reading configuration data /etc/ssh/ssh_config
ssh: Could not resolve hostname debug: Name or service not known
````

重新生成密钥，测试连接依然是22端口连接超时，


今早测试依然失败，
```
$ git remote -v
m       https://github.com/starstarb/starstarb.github.io.git (fetch)
m       https://github.com/starstarb/starstarb.github.io.git (push)
origin  https://github.com/starstarb/starstarb.github.io.git (fetch)
origin  https://github.com/starstarb/starstarb.github.io.git (push)

```
远程仓库有啊？？！！

删了重新改config，443依然被重置

github上的密钥后面也写了，
```

230326401@qq.com
85:38:48:cd:ab:8d:8d:8e:a1:69:b7:96:e3:86:6b:61
Added on Jul 7, 2019
Never used — Read/write
```
并未使用，也就是没有连接上？？


千篇一律的CSDN博客，抄袭太严重了！！！

### SSH学习
SSH是英文Secure Shell的简写形式。通过使用SSH，你可以把所有传输的数据进行加密，这样"中间人"这种攻击方式就不可能实现了，而且也能够防止DNS欺骗和IP欺骗。使用SSH，还有一个额外的好处就是传输的数据是经过压缩的，所以可以加快传输的速度。SSH有很多功能，它既可以代替Telnet，又可以为FTP、Pop、甚至为PPP提供一个安全的"通道"。
SSH协议框架中最主要的部分是三个协议：

* 传输层协议（The Transport Layer Protocol）提供服务器认证，数据机密性，信息完整性 等的支持；

* 用户认证协议（The User Authentication Protocol） 则为服务器提供客户端的身份鉴别；

* 连接协议（The Connection Protocol） 将加密的信息隧道复用成若干个逻辑通道，提供给更高层的应用协议使用； 各种高层应用协议可以相对地独立于SSH基本体系之外，并依靠这个基本框架，通过连接协议使用SSH的安全机制。

> 对于SSH这样以提供安全通讯为目标的协议，其中必不可少的就是一套完备的密钥机制。由于SSH协议是面向互联网网络中主机之间的互访与信息交换，所以主机密钥成为基本的密钥机制。也就是说，SSH协议要求每一个使用本协议的主机都必须至少有一个自己的主机密钥对，服务方通过对客户方主机密钥的认证之后，才能允许其连接请求。一个主机可以使用多个密钥，针对不同的密钥算法而拥有不同的密钥，但是至少有一种是必备的，即通过 DSS算法产生的密钥。

简单地说，每台电脑会通过加密算法生成独立的私钥。

#### SSH的工作过程
在整个通讯过程中，为实现 SSH的安全连接，服务器端与客户端要经历如下五个阶段：

    * 版本号协商阶段，SSH目前包括 SSH1和SSH2两个版本， 双方通过版本协商确定使用的版本

    * 密钥和算法协商阶段，SSH支持多种加密算法， 双方根据本端和对端支持的算法，协商出最终使用的算法

    * 认证阶段，SSH客户端向服务器端发起认证请求， 服务器端对客户端进行认证

    * 会话请求阶段， 认证通过后，客户端向服务器端发送会话请求

    * 交互会话阶段 ，会话请求通过后，服务器端和客户端进行信息的交互


1 . 版本号协商阶段

   1. 服务器打开端口 22，等待客户端连接。

   2. 客户端向服务器端发起 TCP初始连接请求，TCP连接建立后，服务器向客户端发送第一个报文，包括版本标志字符串，格式为“SSH－<主协议版本号>.<次协议版本号>－<软件版本号>”，协议版本号由主版本号和次版本号组成，软件版本号主要是为调试使用。

   3. 客户端收到报文后，解析该数据包，如果服务器端的协议版本号比自己的低，且客户端能支持服务器端的低版本，就使用服务器端的低版本协议号，否则使用自己的协议版本号。

   4. 客户端回应服务器一个报文，包含了客户端决定使用的协议版本号。服务器比较客户端发来的版本号，决定是否能同客户端一起工作。

   5. 如果协商成功，则进入密钥和算法协商阶段，否则服务器端断开 TCP连接。

Note： 版本号协商阶段报文都是采用明文方式传输的。

 

2. 密钥和算法协商阶段

   1. 服务器端和客户端分别发送算法协商报文给对端，报文中包含自己支持的公钥算法列表、加密算法列表、MAC（Message Authentication Code，消息验证码）算法列表、压缩算法列表等;

   2. 服务器端和客户端根据对端和本端支持的算法列表得出最终使用的算法。

   3. 服务器端和客户端利用 DH交换（Diffie-Hellman Exchange）算法、主机密钥对等参数，生成会话密钥和会话 ID。

 

      通过以上步骤，服务器端和客户端就取得了相同的会话密钥和会话ID。

          * 对于后续传输的数据，两端都会使用会话密钥进行加密和解密，保证了数据传送的安全

          * 在认证阶段，两端会使用会话 ID用于认证过程。

      Note：

             在协商阶段之前，服务器端已经生成 RSA或 DSA密钥对，他们主要用于参与会话密钥的生成。

 

 

3. 认证阶段

   1. 客户端向服务器端发送认证请求，认证请求中包含用户名、认证方法、与该认证方法相关的内容（如：password认证时，内容为密码）。

   2. 服务器端对客户端进行认证，如果认证失败，则向客户端发送认证失败消息，其中包含可以再次认证的方法列表。

   3. 客户端从认证方法列表中选取一种认证方法再次进行认证。

   4. 该过程反复进行， 直到认证成功或者认证次数达到上限， 服务器关闭连接为止。

 

SSH提供两种认证方式：

   1. password认证：客户端向服务器发出 password认证请求，将用户名和密码加密后发送给服务器；服务器将该信息解密后得到用户名和密码的明文，与设备上保存的用户名和密码进行比较，并返回认证成功或失败的消息。

   2. publickey 认证：采用数字签名的方法来认证客户端。目前，设备上可以利用RSA和 DSA两种公共密钥算法实现数字签名。客户端发送包含用户名、公共密钥和公共密钥算法的 publickey 认证请求给服务器端。服务器对公钥进行合法性检查，如果不合法，则直接发送失败消息；否则，服务器利用数字签名对客户端进行认证，并返回认证成功或失败的消息

 

SSH2.0还提供了 password-publickey 认证和 any 认证:

   1. password-publickey 认证：指定该用户的认证方式为 password 和 publickey认证同时满足。客户端版本为 SSH1的用户只要通过其中一种认证即可登录；客户端版本为 SSH2的用户必须两种认证都通过才能登录。

   2. any认证：指定该用户的认证方式可以是 password，也可以是 publickey。

 

4.会话请求阶段

   1. 服务器等待客户端的请求；

   2. 认证通过后，客户端向服务器发送会话请求；

   3. 服务器处理客户端的请求。请求被成功处理后， 服务器会向客户端回应 SSH_SMSG_SUCCESS包，SSH进入交互会话阶段；否则回应 SSH_SMSG_FAILURE包，表示服务器处理请求失败或者不能识别请求。

 

5.交互会话阶段

在这个模式下，数据被双向传送：

   1. 客户端将要执行的命令加密后传给服务器;

   2. 服务器接收到报文，解密后执行该命令,将执行的结果加密发还给客户端;

   3. 客户端将接收到的结果解密后显示到终端上.


   Q1: SSH的版本和区别。

    SSH2避免了RSA的专利问题，并修补了CRC的缺陷。SSH2用数字签名算法（DSA）和Diffie-Hellman（DH）算法代替RSA来完成对称密钥的交换，用HMAC来代替CRC。同时SSH2增加了AES和Twofish等对称加密算法。

    A1: SSH(Secure SHell)到目前为止有两个不兼容的版本——SSH1和SSH2。SSH1又分为1.3和1.5两个版本。SSH1采用DES、3DES、 Blowfish和RC4等对称加密算法保护数据安全传输，而对称加密算法的密钥是通过非对称加密算法（RSA）来完成交换的。SSH1使用循环冗余校验码（CRC）来保证数据的完整性，但是后来发现这种方法有缺陷。

    更多内容请参考The SSHv1 Protocol & The SSHv2 Protocol

   

     Q2: 什么是HMAC？

    A2: HMAC(Hash Message Authentication Code) ，散列消息鉴别码，基于密钥的Hash算法的认证协议。消息鉴别码实现鉴别的原理是，用公开函数和密钥产生一个固定长度的值作为认证标识，用这个标识鉴别消息的完整性。使用一个密钥生成一个固定大小的小数据块，即MAC，并将其加入到消息中，然后传输。接收方利用与发送方共享的密钥进行鉴别认证等。

 

    Q3: 什么是X11 forwarding？

    A3: sh的X11 forwarding特性可以使X client和X server安全地通讯。使用X11 forwarding后，从X client到X Server方向的数据先被送至ssh server，ssh server利用和ssh client的安全通道转发给ssh client，再由ssh client转发给X server，从X server到X client的数据流同理。这里ssh server和ssh client充当了X client和X server间数据的转发器，由于ssh server和X client、ssh client和X server一般在同一台机器上，它们之间是一种安全的进程间通讯，而ssh server和ssh client间的通讯也是安全的，所以X client和X server间的通讯就是安全的。

 

    Q4: 什么是TTY？

    A4: 终端是一种字符型设备，它有多种类型，通常使用tty来简称各种类型的终端设备。tty是 Teletype的缩写。Teletype是最早出现的一种终端设备，很象电传打字机，是由Teletype公司生产的。设备名放在特殊文件目录/dev/下。

 

    Q5: 简单描述下SSH运行的过程？

    A5:简要过程如下：

        * Client端向Server端发起SSH连接请求。

        * Server端向Client端发起版本协商。

        * 协商结束后Server端发送Host Key公钥 Server Key公钥，随机数等信息。到这里所有通信是不加密的。

        * Client端返回确认信息，同时附带用公钥加密过的一个随机数，用于双方计算Session Key。

        * 进入认证阶段。从此以后所有通信均加密。

        * 认证成功后，进入交互阶段。


  SSH的常用命令和选项

　　使用方法: ssh [-l login_name] [hostname | user@hostname] [command] ssh [-afgknqtvxCPX246] [-c blowfish | 3des] [-e escape_char] [-i identity_file] [-l login_name] [-o option] [-p port] [-L port:host:hostport] [-R port:host:hostport] [hostname | user@hostname] [command] 

　　(1) 无参数登录ssh, 会自动使用当前系统登录用户名来登录,比如 loger9567   ssh 192.168.1.1 

　　(2) 指定用户名登录  ssh -l roger 192.168.1.1  或者  ssh roger@192.168.1.1 

　　(3) 指定端口(default: 22)  ssh 192.168.1.2 -p 1234 

　　(4) 对所有数据请求压缩  ssh -C 192.168.1.2  适合网速慢的时候,高速网络中反而不好, 在ssh1 中好像不起作用

　　(5) 指定加密算法(default: 3des)  需要修改配置文件, 在 /etc/ssh/ssh_config or ~/.ssh/config 中加入一行 Cipher blowfish #假如使用blowfish算法 

　　(6) 打开调试模式, 追踪ssh的连接情况:  ssh -v 192.168.0.102 

　　(7) 绑定源地址(因为一个客户端可能不止一个IP)  ssh -b 192.168.0.200 -l roger 192.168.1.1 

　　(8) 显示版本 :  ssh -V 192.168.1.1 

　　(9) 指定认证文件:  ssh -i identify_file 192.168.1.1 


##### 查看22端口号被使用的情况

cmd 进去后
```
C:\Users\PC_2017>netstat -ano|findstr 22
  TCP    10.8.34.199:5219       223.202.25.15:443      CLOSE_WAIT      26872
  TCP    10.8.34.199:5279       60.167.222.67:80       CLOSE_WAIT      25540
  TCP    10.8.34.199:5342       183.66.108.220:80      ESTABLISHED     31244
  TCP    10.8.34.199:5345       114.115.221.211:80     ESTABLISHED     29256
  TCP    10.8.34.199:5369       182.92.244.228:443     ESTABLISHED     4600
  UDP    127.0.0.1:6622         *:*                                    20936

```
昨天使用taskkill -F 强制关闭了22端口对应的进程号并没什么用！



？？？我按照网上的更改到443端口后，重新打开ssh下git bash后，启动测试正常了？？？
这到底咋回事啊？？
不过还好能提交了。




哦豁，第三次提交又提交不上去了。。443端口一直被重置？？
提交过的那一回出现了konwn_hosts文件，里面内容如下：
```
[ssh.github.com]:443,[192.30.253.122]:443 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
[192.30.253.123]:443 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==

```


重新打开又能登陆了，是不是连接太慢？


又登陆不了了，调试信息如下：
```
$ ssh -v 192.30.253.122 -p  443
OpenSSH_7.9p1, OpenSSL 1.1.1a  20 Nov 2018
debug1: Reading configuration data /c/Users/PC_2017/.ssh/config
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: Connecting to 192.30.253.122 [192.30.253.122] port 443.
debug1: Connection established.
debug1: identity file /c/Users/PC_2017/.ssh/id_rsa type 0
debug1: identity file /c/Users/PC_2017/.ssh/id_rsa-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_dsa type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_dsa-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ecdsa type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ecdsa-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ed25519 type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ed25519-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_xmss type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_xmss-cert type -1
debug1: Local version string SSH-2.0-OpenSSH_7.9
debug1: Remote protocol version 2.0, remote software version babeld-93408c70
debug1: no match: babeld-93408c70
debug1: Authenticating to 192.30.253.122:443 as 'PC_2017'
debug1: SSH2_MSG_KEXINIT sent
debug1: SSH2_MSG_KEXINIT received
debug1: kex: algorithm: curve25519-sha256
debug1: kex: host key algorithm: rsa-sha2-512
debug1: kex: server->client cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: kex: client->server cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: expecting SSH2_MSG_KEX_ECDH_REPLY
Connection reset by 192.30.253.122 port 443

```

即ssh第一阶段版本协商时，客户端和服务端版本不匹配，远程是babeld-93408c70,本地是SSH？？？


还有一种情况，ssh测试登陆成功后，但是打开hexo 提交时，然后，443端口依然被重置？？

明明第一次
```
$ ssh -T git@github.com
Hi starstarb! You've successfully authenticated, but GitHub does not provide shell access.

```
然后第二次，再次测试：
```
$ ssh -T git@github.com
Connection reset by 192.30.253.122 port 443

```
被重置了。
是端口号的进程太多了？

梳理一下：
```
$ ssh -v 192.30.253.122
OpenSSH_7.9p1, OpenSSL 1.1.1a  20 Nov 2018
debug1: Reading configuration data /c/Users/PC_2017/.ssh/config
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: Connecting to 192.30.253.122 [192.30.253.122] port 22.
debug1: connect to address 192.30.253.122 port 22: Connection timed out
ssh: connect to host 192.30.253.122 port 22: Connection timed out


$ ssh -v 192.30.253.122 -p 443
OpenSSH_7.9p1, OpenSSL 1.1.1a  20 Nov 2018
debug1: Reading configuration data /c/Users/PC_2017/.ssh/config
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: Connecting to 192.30.253.122 [192.30.253.122] port 443.
debug1: Connection established.
debug1: identity file /c/Users/PC_2017/.ssh/id_rsa type 0
debug1: identity file /c/Users/PC_2017/.ssh/id_rsa-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_dsa type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_dsa-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ecdsa type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ecdsa-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ed25519 type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_ed25519-cert type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_xmss type -1
debug1: identity file /c/Users/PC_2017/.ssh/id_xmss-cert type -1
debug1: Local version string SSH-2.0-OpenSSH_7.9
debug1: Remote protocol version 2.0, remote software version babeld-93408c70
debug1: no match: babeld-93408c70
debug1: Authenticating to 192.30.253.122:443 as 'PC_2017'
debug1: SSH2_MSG_KEXINIT sent
debug1: SSH2_MSG_KEXINIT received
debug1: kex: algorithm: curve25519-sha256
debug1: kex: host key algorithm: rsa-sha2-512
debug1: kex: server->client cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: kex: client->server cipher: chacha20-poly1305@openssh.com MAC: <implicit> compression: none
debug1: expecting SSH2_MSG_KEX_ECDH_REPLY
Connection reset by 192.30.253.122 port 443



$ ssh -T git@github.com
Hi starstarb! You've successfully authenticated, but GitHub does not provide shell access.

```
成功
然后第三次提交，又失败了




每三次失败后，重新调试，关闭git bash 后，再重新打开hexo deploy正常。


总结：如果提交失败，那么先测试443端口：
```
$ ssh -v 192.30.253.122 -p 443
$ ssh -T git@github.com
```
成功后，关闭当前Session,重新打开git bash,即可正常提交
