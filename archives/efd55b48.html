<!DOCTYPE html>

<html class="theme-next gemini use-motion" lang="zh-Hans">

<head>
  <meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
                                                                                  content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#222">

  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"
                                                                                  type="text/css">

  <link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"
                                                                                  type="text/css">

  <link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">

  <link rel="apple-touch-icon" sizes="180x180"
                                                                                  href="/images/apple-touch-icon-next.png?v=5.1.4">

  <link rel="icon" type="image/png" sizes="32x32"
                                                                                  href="/images/favicon-32x32-next.png?v=5.1.4">

  <link rel="icon" type="image/png" sizes="16x16"
                                                                                  href="/images/favicon-16x16-next.png?v=5.1.4">

  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">

  <meta name="keywords" content="RabbitMQ,">

  <link rel="alternate" href="/atom.xml" title="star"
                                                                                  type="application/atom+xml">

  <meta name="description" content="消息中间件之RabbigMQ">
  <meta name="keywords" content="RabbitMQ">
  <meta property="og:type" content="article">
  <meta property="og:title" content="消息中间件之RabbitMq学习">
  <meta property="og:url" content="http://javastar.club/archives/efd55b48.html">
  <meta property="og:site_name" content="star">
  <meta property="og:description" content="消息中间件之RabbigMQ">
  <meta property="og:locale" content="zh-Hans">
  <meta property="og:updated_time" content="2019-08-07T07:14:52.720Z">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="消息中间件之RabbitMq学习">
  <meta name="twitter:description" content="消息中间件之RabbigMQ">

  <script type="text/javascript" id="hexo.configurations">
    var NexT = window.NexT || {};
    var CONFIG = {
      root: '/',
      scheme: 'Gemini',
      version: '5.1.4',
      sidebar: {
        "position": "left",
        "display": "post",
        "offset": 12,
        "b2t": false,
        "scrollpercent": false,
        "onmobile": false
      },
      fancybox: true,
      tabs: true,
      motion: {
        "enable": true,
        "async": false,
        "transition": {
          "post_block": "fadeIn",
          "post_header": "slideDownIn",
          "post_body": "slideDownIn",
          "coll_header": "slideLeftIn",
          "sidebar": "slideUpIn"
        }
      },
      duoshuo: {
        userId: '0',
        author: '博主'
      },
      algolia: {
        applicationID: '',
        apiKey: '',
        indexName: '',
        hits: {
          "per_page": 10
        },
        labels: {
          "input_placeholder": "Search for Posts",
          "hits_empty": "We didn't find any results for the search: ${query}",
          "hits_stats": "${hits} results found in ${time} ms"
        }
      }
    };

  </script>

  <link rel="canonical" href="http://javastar.club/archives/efd55b48.html">

  <title>消息中间件之RabbitMq学习 | star</title>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope
                                                                                    itemtype="http://schema.org/WPHeader">
      <div class="header-inner">
        <div class="site-brand-wrapper">
          <div class="site-meta ">

            <div class="custom-logo-site-title">
              <a href="/" class="brand" rel="start">
                <span class="logo-line-before"><i></i></span>
                <span class="site-title">star</span>
                <span class="logo-line-after"><i></i></span>
              </a>
            </div>

            <p class="site-subtitle">前端小白|java萌新|Geek精神</p>

          </div>

          <div class="site-nav-toggle">
            <button>
              <span class="btn-bar"></span>
              <span class="btn-bar"></span>
              <span class="btn-bar"></span>
            </button>
          </div>
        </div>

        <nav class="site-nav">

          <ul id="menu" class="menu">

            <li class="menu-item menu-item-home">
              <a href="/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-home"></i> <br>

                首页
              </a>
            </li>

            <li class="menu-item menu-item-categories">
              <a href="/categories/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-th"></i> <br>

                分类
              </a>
            </li>

            <li class="menu-item menu-item-archives">
              <a href="/archives/" rel="section">

                <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>

                归档
              </a>
            </li>

          </ul>

        </nav>

      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">

            <div id="posts" class="posts-expand">

              <article class="post post-type-normal" itemscope
                                                                                              itemtype="http://schema.org/Article">

                <div class="post-block">
                  <link itemprop="mainEntityOfPage"
                                                                                                  href="http://javastar.club/archives/efd55b48.html">

                  <span hidden itemprop="author" itemscope
                                                                                                  itemtype="http://schema.org/Person">
                    <meta itemprop="name" content="stardust">
                    <meta itemprop="description" content>
                    <meta itemprop="image" content="/images/head.jpg">
                  </span>

                  <span hidden itemprop="publisher" itemscope
                                                                                                  itemtype="http://schema.org/Organization">
                    <meta itemprop="name" content="star">
                  </span>

                  <header class="post-header">

                    <h1 class="post-title" itemprop="name headline">
                      消息中间件之RabbitMq学习</h1>

                    <div class="post-meta">
                      <span class="post-time">

                        <span class="post-meta-item-icon">
                          <i class="fa fa-calendar-o"></i>
                        </span>

                        <span class="post-meta-item-text">发表于</span>

                        <time title="创建于" itemprop="dateCreated datePublished"
                                                                                                        datetime="2019-07-27T16:40:40+08:00">
                          2019-07-27
                        </time>

                        <span class="post-meta-divider">|</span>

                        <span class="post-meta-item-icon">
                          <i class="fa fa-calendar-check-o"></i>
                        </span>

                        <span class="post-meta-item-text">更新于&#58;</span>

                        <time title="更新于" itemprop="dateModified"
                                                                                                        datetime="2019-08-07T15:14:52+08:00">
                          2019-08-07
                        </time>

                      </span>

                      <span class="post-category">

                        <span class="post-meta-divider">|</span>

                        <span class="post-meta-item-icon">
                          <i class="fa fa-folder-o"></i>
                        </span>

                        <span class="post-meta-item-text">分类于</span>

                        <span itemprop="about" itemscope
                                                                                                        itemtype="http://schema.org/Thing">
                          <a href="/categories/消息中间件/" itemprop="url"
                                                                                                          rel="index">
                            <span itemprop="name">消息中间件</span>
                          </a>
                        </span>

                      </span>

                      <span class="post-comments-count">
                        <span class="post-meta-divider">|</span>
                        <span class="post-meta-item-icon">
                          <i class="fa fa-comment-o"></i>
                        </span>
                        <a href="/archives/efd55b48.html#comments"
                                                                                                        itemprop="discussionUrl">
                          <span class="post-comments-count valine-comment-count" data-xid="/archives/efd55b48.html"
                                                                                                          itemprop="commentCount"></span>
                        </a>
                      </span>

                      <span id="/archives/efd55b48.html" class="leancloud_visitors"
                                                                                                      data-flag-title="消息中间件之RabbitMq学习">
                        <span class="post-meta-divider">|</span>
                        <span class="post-meta-item-icon">
                          <i class="fa fa-eye"></i>
                        </span>

                        <span class="post-meta-item-text">热度&#58;</span>

                        <span class="leancloud-visitors-count"></span>
                        <span>℃</span>
                      </span>

                      <div class="post-wordcount">

                        <span class="post-meta-item-icon">
                          <i class="fa fa-file-word-o"></i>
                        </span>

                        <span class="post-meta-item-text">字数统计&#58;</span>

                        <span title="字数统计">
                          13k
                        </span>

                        <span class="post-meta-divider">|</span>

                        <span class="post-meta-item-icon">
                          <i class="fa fa-clock-o"></i>
                        </span>

                        <span class="post-meta-item-text">阅读时长 &asymp;</span>

                        <span title="阅读时长">
                          59
                        </span>

                      </div>

                    </div>
                  </header>

                  <div class="post-body" itemprop="articleBody">

                    <p>消息中间件之RabbigMQ</p>
                    <a id="more"></a>
                    <h3 id="RabbitMQ简介"><a href="#RabbitMQ简介" class="headerlink"
                                                                                                      title="RabbitMQ简介"></a>RabbitMQ简介
                    </h3>
                    <pre><code>RabbitMQ是一个消息代理，用于接受消息和转发消息。
RabbitMQ接受、存储和转发二进制数据块---即消息。
尽管消息流经RabbitMQ，但他们只能存储在队列中。
一个队列只受主机内存和磁盘限制约束，它本质上是一个很大的消息缓冲区</code></pre>
                    <h3 id="消息队列"><a href="#消息队列" class="headerlink"
                                                                                                      title="消息队列"></a>消息队列
                    </h3>
                    <p> 消息(Message)是指在应用间传送的数据。<br> 消息队列(Message
                      Queue)是一种应用间通信的方式，消息发送后可以立即返回，由消息系统来确保消息的可靠传递。<br>
                      消息发布者只管把消息发布到MQ中而不用管谁来取，消息使用者只管从MQ中取消息而不管是谁发布的。<br>
                      因此，发布者和使用者都不用知道对方的存在。<br>
                      消息队列是一种应用间的异步协作机制。<br> 常见场景：广播、错峰流控、最终一致性、业务解耦</p>
                    <h3 id="RabbitMQ特点"><a href="#RabbitMQ特点" class="headerlink"
                                                                                                      title="RabbitMQ特点"></a>RabbitMQ特点
                    </h3>
                    <p>RabbitMQ 是一个由 Erlang 语言开发的 AMQP 的开源实现。</p>
                    <p>AMQP ：Advanced Message
                      Queue，高级消息队列协议。它是应用层协议的一个开放标准，为面向消息的中间件设计，基于此协议的客户端与消息中间件可传递消息，并不受产品、开发语言等条件的限制。
                    </p>
                    <p>RabbitMQ
                      最初起源于金融系统，用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。具体特点包括：</p>
                    <p>（1）可靠性（Reliability）<br>RabbitMQ
                      使用一些机制来保证可靠性，如持久化、传输确认、发布确认。</p>
                    <p>（2）灵活的路由（Flexible Routing）<br>在消息进入队列之前，通过 Exchange
                      来路由消息的。对于典型的路由功能，RabbitMQ
                      已经提供了一些内置的 Exchange 来实现。针对更复杂的路由功能，可以将多个 Exchange
                      绑定在一起，也通过插件机制实现自己的 Exchange
                      。</p>
                    <p>（3）消息集群（Clustering）<br>多个 RabbitMQ 服务器可以组成一个集群，形成一个逻辑
                      Broker 。</p>
                    <p>（4）高可用（Highly Available
                      Queues）<br>队列可以在集群中的机器上进行镜像，使得在部分节点出问题的情况下队列仍然可用。</p>
                    <p>（5）多种协议（Multi-protocol）<br>RabbitMQ 支持多种消息队列协议，比如
                      STOMP、MQTT 等等。</p>
                    <p>（6）多语言客户端（Many Clients）<br>RabbitMQ 几乎支持所有常用语言，比如
                      Java、.NET、Ruby 等等。</p>
                    <p>（7）管理界面（Management UI）<br>RabbitMQ
                      提供了一个易用的用户界面，使得用户可以监控和管理消息 Broker 的许多方面。
                    </p>
                    <p>（8）跟踪机制（Tracing）<br>如果消息异常，RabbitMQ
                      提供了消息跟踪机制，使用者可以找出发生了什么。</p>
                    <p>（9）插件机制（Plugin System）<br>RabbitMQ
                      提供了许多插件，来从多方面进行扩展，也可以编写自己的插件。</p>
                    <h3 id="RabbitMQ中的概念模型–消息模型"><a href="#RabbitMQ中的概念模型–消息模型" class="headerlink"
                                                                                                      title="RabbitMQ中的概念模型–消息模型"></a>RabbitMQ中的概念模型–消息模型
                    </h3>
                    <p>所有 MQ
                      产品从模型抽象上来说都是一样的过程：<br>消费者（consumer）订阅某个队列。生产者（producer）创建消息，然后发布到队列（queue）中，最后将消息发送到监听的消费者。
                    </p>
                    <h3 id="RabbitMQ基本概念"><a href="#RabbitMQ基本概念" class="headerlink"
                                                                                                      title="RabbitMQ基本概念"></a>RabbitMQ基本概念
                    </h3>
                    <p>
                      （1）Message<br>消息，消息是不具名的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性存储）等。<br>（2）Publisher<br>消息的生产者，也是一个向交换器发布消息的客户端应用程序。<br>（3）Exchange<br>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。<br>（4）Binding<br>绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交换器理解成一个由绑定构成的路由表。<br>（5）Queue<br>消息队列，用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。<br>（6）Connection<br>网络连接，比如一个TCP连接。<br>（7）Channel<br>信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内地虚拟连接，AMQP
                      命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁
                      TCP
                      都是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP
                      连接。<br>（8）Consumer<br>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序。<br>（9）Virtual
                      Host<br>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个
                      vhost 本质上就是一个
                      mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP
                      概念的基础，必须在连接时指定，RabbitMQ
                      默认的 vhost 是 / 。<br>（10）Broker<br>表示消息队列服务器实体。</p>
                    <h3 id="RabbitMQ消息持久性、确认机制、拒绝、预取数量、分配策略"><a href="#RabbitMQ消息持久性、确认机制、拒绝、预取数量、分配策略"
                                                                                                      class="headerlink"
                                                                                                      title="RabbitMQ消息持久性、确认机制、拒绝、预取数量、分配策略"></a>RabbitMQ消息持久性、确认机制、拒绝、预取数量、分配策略
                    </h3>
                    <ol>
                      <li>
                        <p>
                          消息的持久性<br>为了保证消息的可靠性，需要对消息进行持久化。<br>为了保证RabbitMQ在重启、奔溃等异常情况下数据没有丢失，除了对消息本身持久化为，还需要将消息传输经过的队列(queue)，交互机进行持久化(exchange)，持久化以上元素后，消息才算真正RabbitMQ重启不会丢失。
                        </p>
                        <p><strong>消息持久化</strong><br>方法：</p>
                        <figure class="highlight plain">
                          <table>
                            <tr>
                              <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                              </td>
                              <td class="code">
                                <pre><span class="line">void basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body) throws IOException;</span><br></pre>
                              </td>
                            </tr>
                          </table>
                        </figure>

                        <p>第三个参数props：设置投递模式为持久化，如果此值是persistent
                          ，则此消息存储在磁盘上。如果服务器重启，系统会保证收到的持久化消息未丢失，将消息以持久化方式发布时，会对性能造成一定的影响<br>消息持久化代码如下:
                        </p>
                        <figure class="highlight plain">
                          <table>
                            <tr>
                              <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                              </td>
                              <td class="code">
                                <pre><span class="line">channel.basicPublish(&quot;&quot;, TASK_QUEUE_NAME,</span><br><span class="line">                    MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">                    message.getBytes(&quot;UTF-8&quot;));</span><br></pre>
                              </td>
                            </tr>
                          </table>
                        </figure>

                      </li>
                    </ol>
                    <p>队列持久化：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">Queue.DeclareOk queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete,</span><br><span class="line">                                 Map&lt;String, Object&gt; arguments) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>参数解释：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">第二个参数 durable</span><br><span class="line">是否持久化，如果true，则此种队列叫持久化队列（Durable queues）。此队列会被存储在磁盘上，当消息代理（broker）重启的时候，它依旧存在。没有被持久化的队列称作暂存队列（Transient queues）。</span><br><span class="line">第三个参数 execulusive</span><br><span class="line">表示此对应只能被当前创建的连接使用，而且当连接关闭后队列即被删除。此参考优先级高于durable</span><br><span class="line">第四个参数 autoDelete</span><br><span class="line">当没有生成者/消费者使用此队列时，此队列会被自动删除。</span><br><span class="line">(即当最后一个消费者退订后即被删除)</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>代码：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>交换机持久化：<br>声明交换机方法</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">Exchange.DeclareOk exchangeDeclare(String exchange, String type, boolean durable) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>方法参数说明：</p>
                    <blockquote>
                      <p>第三个参数durable:交换机是否持久化</p>
                    </blockquote>
                    <p>
                      <strong>消息确认机制</strong><br>消费者在处理消息的时候偶尔会失败或者有时会直接崩溃掉。而且网络原因也有可能引起各种问题，对于此AMQP有两种处理方式：
                    </p>
                    <pre><code>○ 自动确认模式（automatic acknowledgement model）：当RabbbitMQ将消息发送给应用后，消费者端自动回送一个确认消息，此时RabbitMQ删除此消息。
○ 显式确认模式（explicit acknowledgement model）：消费者收到消息后，可以在执行一些逻辑后，消费者自己决定什么时候发送确认回执（acknowledgement），RabbitMQ收到回执后才删除消息，这样就保证消费端不会丢失消息</code></pre>
                    <p>
                      如果一个消费者在尚未发送确认回执的情况下挂掉了，那么消息会被重新放入队列，并且在还有其他消费者存在于此队列的前提下，立即投递给另外一个消费者。如果当时没有可用的消费者了，消息代理会死等下一个注册到此队列的消费者，然后再次尝试投递。<br>RabbitMQ里的消息是不会过期。当消费者挂掉后，RabbitMQ会不断尝试重推。所有单个消息的推送可能花费很长的时间
                    </p>
                    <p>是否开启自动确认模式由以下方法的autoAck属性决定</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">String basicConsume(String queue, boolean autoAck, Consumer callback) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>代码实现</p>
                    <pre><code>a 自动确认模式：只需要设置此值为autoAck为true即可.
b. 显示确认模式：见WorkQueuesRecv.java</code></pre>
                    <p>WorkQueuesRecv有两个注意点：<br>a.
                      channel.basicConsume()第二个参数autoAck值为false<br>b.
                      收到消息后，必须调用 channel.basicAck 向rabbitMQ发送确认回执</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.workqueues;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">/**</span><br><span class="line"> * Created by huangrongyou@yixin.im on 2018/1/9.</span><br><span class="line"> */</span><br><span class="line">public class WorkQueuesRecv &#123;</span><br><span class="line">    private static final String TASK_QUEUE_NAME = &quot;task_queue&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password, int id)&#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            final Connection connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            final Channel channel = connection.createChannel();</span><br><span class="line">            // 声明一个队列</span><br><span class="line">            channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);</span><br><span class="line">            System.out.println(&quot; [WorkQueuesRecv-&quot; +id+ &quot;] Waiting for messages.&quot;);</span><br><span class="line">            // 每个客户端每次最后获取N个消息</span><br><span class="line">        //    channel.basicQos(1);</span><br><span class="line">            // 默认消费者实现</span><br><span class="line">            final Consumer consumer = new DefaultConsumer(channel) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="line">                    String message = new String(body, &quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">                    System.out.println(&quot; [WorkQueuesRecv-&quot; +id+ &quot;] Received &apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">                    try &#123;</span><br><span class="line">                        doWork(message);</span><br><span class="line">                    &#125; finally &#123;</span><br><span class="line">                        System.out.println(&quot; [WorkQueuesRecv-&quot; +id+ &quot;] Done&quot;);</span><br><span class="line"></span><br><span class="line">                        // 情况一：对处理好的消息进行应答</span><br><span class="line">                        channel.basicAck(envelope.getDeliveryTag(), false);</span><br><span class="line"></span><br><span class="line">                        // 情况二：对于id=0的消费者者正常应答消息，其它id=0，解决此消息并要求重发</span><br><span class="line">//                        if(id == 0)&#123;</span><br><span class="line">//                            // 对处理好的消息进行应答</span><br><span class="line">//                            channel.basicAck(envelope.getDeliveryTag(), false);</span><br><span class="line">//                        &#125;else &#123;</span><br><span class="line">                            // 拒绝当前这条消息</span><br><span class="line">                  //          channel.basicReject(envelope.getDeliveryTag(), true);</span><br><span class="line">                            // 拒绝包含本条delivery_tag 所对应消息在内的所有比该值小的消息都被拒绝了（除了已经被 ack 的以外)</span><br><span class="line">                            // channel.basicNack(envelope.getDeliveryTag(), false, false);</span><br><span class="line">//                        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            // 获取消息</span><br><span class="line">            channel.basicConsume(TASK_QUEUE_NAME, false, consumer);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void doWork(String task) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">        &#125; catch (InterruptedException _ignored) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>消息确认方法：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">void basicAck(long deliveryTag, boolean multiple) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>方法详细参数如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">第一个参数deliveryTag：发布的每一条消息都会获得一个唯一的deliveryTag，(任何channel上发布的第一条消息的deliveryTag为1，此后的每一条消息都会加1)，deliveryTag在channel范围内是唯一的</span><br><span class="line">第二个参数multiple：批量确认标志。如果值为true，则执行批量确认，此deliveryTag之前收到的消息全部进行确认; 如果值为false，则只对当前收到的消息进行确认</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>
                      备注：<br>如果在获取消息时采用不自动应答，但是获取消息后不调用basicAck，则后果会很严重。RabbitMQ会认为消息没有投递成功，不仅所有的消息都会保留到内存中，而且在客户重新连接后，会将所有的消息重新投递一遍
                    </p>
                    <p><strong>拒绝消息</strong></p>
                    <p>
                      当消费者接收到某条消息后，处理过程有可能失败，这时消费者可以拒绝此消息。在拒绝消息时，消费者会告诉RabbitMQ如何处理这条消息：销毁它或者重新放入队列。<br>可以有两种方式拒绝此消息
                    </p>
                    <p>a. channel.basicReject：只支持对一条消息进行拒绝<br>拒绝方法:</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">void basicReject(long deliveryTag, boolean requeue) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>方法详细参数如下：</p>
                    <pre><code>第一个参数deliveryTag：发布的每一条消息都会获得一个唯一的deliveryTag，deliveryTag在channel范围内是唯一的
第二个参数requeue：表示如何处理这条消息，如果值为true，则重新放入RabbitMQ的发送队列，如果值为false，则通知RabbitMQ销毁这条消息</code></pre>
                    <p>代码如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">channel.basicReject(envelope.getDeliveryTag(), true);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>b. channel.basicNack<br>channel.basicNack是
                      channel.basicReject的补充，提供一次对多条消息进行拒绝的功能<br>方法如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">void basicNack(long deliveryTag, boolean multiple, boolean requeue) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>方法参数：</p>
                    <p>
                      第一个参数deliveryTag：发布的每一条消息都会获得一个唯一的deliveryTag，deliveryTag在channel范围内是唯一的
                    </p>
                    <p>
                      第二个参数multiple：批量确认标志。如果值为true，包含本条消息在内的、所有比该消息deliveryTag值小的
                      消息都被拒绝了（除了已经被
                      ack 的以外）;如果值为false，只拒绝三本条消息</p>
                    <p>
                      第三个参数requeue：表示如何处理这条消息，如果值为true，则重新放入RabbitMQ的发送队列，如果值为false，则通知RabbitMQ销毁这条消息
                    </p>
                    <p>代码如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">channel.basicNack(envelope.getDeliveryTag(), false, false);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>
                      备注：<br>当此队列只有一个消费者时，请确认不要由于拒绝消息并且选择了重新放入队列的行为而引起消息在同一个消费者身上无限循环的情况发生。
                    </p>
                    <p><strong>设置预取消息的数量</strong></p>
                    <p>
                      默认情况下，RabbitMQ收到消息后，就向消费者送。但是如果消息过多，且消息的数量超过了消息者处理能力从而导致其崩溃。此时我们可以通过prefetchCount
                      限制每个消费者在收到下一个确认回执前一次可以最大接受多少条消息。即如果设置prefetchCount
                      =1，RabbitMQ向这个消费者发送一个消息后，再这个消息的消费者对这个消息进行ack之前，RabbitMQ不会向这个消费者发送新的消息
                    </p>
                    <p>代码如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">// 每个客户端每次最后获取N个消息</span><br><span class="line">channel.basicQos(1);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>
                      <strong>消息分配策略</strong><br>多个消费者同时消费同一个队列，Rabbit的消息的分配策略是什么？<br>如果同一个队列，有多个消费者消费这个队列。RabbitMQ默认是按照轮询的策略发送消息，即发送的顺序是消费者1，消费者2，消费者1，消费者2…。所以平均下来，每个消费者消费的消息数量几乎相同。
                    </p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.workqueues;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.Channel;</span><br><span class="line">import com.rabbitmq.client.Connection;</span><br><span class="line">import com.rabbitmq.client.ConnectionFactory;</span><br><span class="line">import com.rabbitmq.client.MessageProperties;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by huangrongyou@yixin.im on 2018/1/9.</span><br><span class="line"> */</span><br><span class="line">public class WorkQueuesSend &#123;</span><br><span class="line">    private static final String TASK_QUEUE_NAME = &quot;task_queue&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password) &#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line">        Connection connection = null;</span><br><span class="line">        Channel channel = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            // queueDeclarePassive(String queue)可以用来检测一个queue是否已经存在</span><br><span class="line">            // Queue.DeclareOk queueDeclarePassive(String queue) throws IOException</span><br><span class="line">            // 声明一个队列</span><br><span class="line">            channel.queueDeclare(TASK_QUEUE_NAME, true, false, false, null);</span><br><span class="line"></span><br><span class="line">            String message = &quot;Work Queues!&quot; + System.currentTimeMillis();</span><br><span class="line">            // 发送一个持久化消息</span><br><span class="line">            channel.basicPublish(&quot;&quot;, TASK_QUEUE_NAME,</span><br><span class="line">                    MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">                    message.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">            System.out.println(&quot; [WorkQueuesSend] Sent &apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic;</span><br><span class="line"></span><br><span class="line">import com.hry.spring.rabbitmq.basic.helloworld.HelloworldRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.helloworld.HelloworldSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.publishsubscribe.Publish;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.publishsubscribe.Subscribe;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.routing.RoutingRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.routing.RoutingSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.rpc.RpcClient;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.rpc.RpcServer;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.topics.TopicsRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.topics.TopicsSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.workqueues.WorkQueuesRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.workqueues.WorkQueuesSend;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by huangrongyou@yixin.im on 2018/1/10.</span><br><span class="line"> */</span><br><span class="line">public class BasicTest &#123;</span><br><span class="line">    // 测试线程池</span><br><span class="line">    private ExecutorService executorService = Executors.newFixedThreadPool(10);</span><br><span class="line"></span><br><span class="line">    // rabbitmq的IP地址</span><br><span class="line">    private final String rabbitmq_host = &quot;10.240.80.147&quot;;</span><br><span class="line">    // rabbitmq的用户名称</span><br><span class="line">    private final String rabbitmq_user = &quot;hry&quot;;</span><br><span class="line">    // rabbitmq的用户密码</span><br><span class="line">    private final String rabbitmq_pwd = &quot;hry&quot;;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void helloworld() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            HelloworldRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line"></span><br><span class="line">        // 发送端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            HelloworldSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void workqueues() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                WorkQueuesRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 4;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                WorkQueuesSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void publishsubscribe() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Subscribe.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 2;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Publish.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void routing_1() throws InterruptedException &#123;</span><br><span class="line">        // 接收端 1：绑定 orange 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;orange&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line">        // 接收端 2：绑定 black、green 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;black&quot;,&quot;green&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端 ： 发送 black，只有接收端1收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;orange&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 发送端 ： 发送 green、black，只有接收端2收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;green&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void routing_2() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 接收端：同时创建两个接收端，同时绑定black</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">             // 接收端：绑定 black 值</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                String[] colours = &#123;&quot;black&quot;&#125;;</span><br><span class="line">                RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;black&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 发送端2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;green&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void topics() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 消费者1：绑定 *.orange.* 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] bindingKeys = &#123;&quot;*.orange.*&quot;&#125;;</span><br><span class="line">            TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者2：绑定  &quot;*.*.rabbit&quot; 和 &quot;lazy.#&quot;值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] bindingKeys = &#123;&quot;*.*.rabbit&quot;, &quot;lazy.#&quot;&#125;;</span><br><span class="line">            TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 生产者1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;quick.orange.rabbit&quot;;</span><br><span class="line">            TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 生产者2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;lazy.pink.rabbit&quot;;</span><br><span class="line">            TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void rpc() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // rpc服务端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            RpcServer.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // rpc客户端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            RpcClient.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, &quot;rpc test&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <h3 id="RabbitMQ之交换机的四种类型和属性"><a href="#RabbitMQ之交换机的四种类型和属性" class="headerlink"
                                                                                                      title="RabbitMQ之交换机的四种类型和属性"></a>RabbitMQ之交换机的四种类型和属性
                    </h3>
                    <p><strong>交换机作用</strong><br>
                      在RabbitMQ中，生产者不是直接将消息发送给消费者，生成者根本不知道这个消息要传递给哪些队列。实际上，生产者只是将消息发送到交换机。交换机收到消息到，根据交换机的类型和配置来处理消息，有如下几种情况：
                    </p>
                    <pre><code>将消息传送到特定的队列
有可能发送到多个队列中
也有可能丢弃消息</code></pre>
                    <p>RabbitMQ各个组件的功能重新归纳一下如下：</p>
                    <pre><code>生产者：发送消息
交换机：将收到的消息根据路由规则路由到特定队列
队列：用于存储消息
消费者：收到消息并消费</code></pre>
                    <p><strong>交换机的类型</strong><br> 交换机主要包括如下4种类型：</p>
                    <pre><code>Direct exchange（直连交换机）
Fanout exchange（扇型交换机）
Topic exchange（主题交换机）
Headers exchange（头交换机）</code></pre>
                    <p>另外RabbitMQ默认定义一些交换机：</p>
                    <pre><code>默认交换机
amq.* exchanges</code></pre>
                    <p>还有一类特殊的交换机：Dead Letter Exchange（死信交换机）<br>Direct
                      exchange（直连交换机）</p>
                    <p><strong>直连型交换机（direct exchange）</strong><br>
                      是根据消息携带的路由键（routing
                      key）将消息投递给对应队列的，步骤如下：</p>
                    <pre><code>1.将一个队列绑定到某个交换机上，同时赋予该绑定一个路由键（routing key）
2.当一个携带着路由值为R的消息被发送给直连交换机时，交换机会把它路由给绑定值同样为R的队列。</code></pre>
                    <p>
                      有时我们不希望所有的消息都被所有队列接收，我们希望可以指定类型为a的消息只能被队列A接收，类型为b的消息只能被队列B,C接收。扇型交换机只能无脑地广播消息给所有的消费者，其实质是广播给所有关联的队列。<br>为了实现这个功能，一种是建立多个交换机，这种方式简单暴力但是不灵活。本节我们介绍使用单个直连交换机+路由实现以上功能。
                    </p>
                    <p>单个绑定和多个绑定</p>
                    <p><strong>生产者代码：</strong></p>
                    <p>主要业务逻辑如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">1. 配置连接工厂</span><br><span class="line">2. 建立TCP连接</span><br><span class="line">3. 在TCP连接的基础上创建通道</span><br><span class="line">4. 声明一个direct交换机 </span><br><span class="line">5. 发送消息，并配置消息的路由键</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>第四、五步代码如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">// 声明一个direct交换机</span><br><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">String message = &quot;RoutingSend-&quot; + System.currentTimeMillis();</span><br><span class="line">// 发送消息，并配置消息的路由键</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes(&quot;UTF-8&quot;));</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>RoutingSend.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.routing;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line">import com.rabbitmq.client.Channel;</span><br><span class="line">import com.rabbitmq.client.Connection;</span><br><span class="line">import com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line">public class RoutingSend &#123;</span><br><span class="line">    private static final String EXCHANGE_NAME = &quot;direct_logs&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password, String routingKey) &#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line"></span><br><span class="line">        Connection connection = null;</span><br><span class="line">        Channel channel = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            // 声明一个direct交换机</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">            String message = &quot;RoutingSend-&quot; + System.currentTimeMillis();</span><br><span class="line">            // 发送消息，并配置消息的路由键</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">            System.out.println(&quot; [RoutingSend] Sent &apos;&quot; + routingKey + &quot;&apos;:&apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // 空值判断，为了代码简洁略</span><br><span class="line">                channel.close();</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p><strong>消费者的代码</strong></p>
                    <p>主要业务逻辑如下：</p>
                    <ol>
                      <li>配置连接工厂</li>
                      <li>建立TCP连接</li>
                      <li>在TCP连接的基础上创建通道</li>
                      <li>声明一个direct交换机</li>
                      <li>声明一个临时队列</li>
                      <li>将临时队列绑定到交换机上，并在队列上绑定多个绑定值</li>
                      <li>接收消息并处理</li>
                    </ol>
                    <p>第4,5,6步代码如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">// 声明一个direct交换机</span><br><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">// 声明一个临时队列</span><br><span class="line">String queueName = channel.queueDeclare().getQueue();</span><br><span class="line">// 绑定路由，同一个队列可以绑定多个值</span><br><span class="line">for (String colour : colours) &#123;</span><br><span class="line">    channel.queueBind(queueName, EXCHANGE_NAME, colour);</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>RoutingRecv.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.routing;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public class RoutingRecv &#123;</span><br><span class="line">    private static final String EXCHANGE_NAME = &quot;direct_logs&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password, String[] colours)&#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line"></span><br><span class="line">        Connection connection = null;</span><br><span class="line">        Channel channel = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            // 声明一个direct交换机</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">            // 声明一个临时队列</span><br><span class="line">            String queueName = channel.queueDeclare().getQueue();</span><br><span class="line">            // 绑定路由，同一个队列可以绑定多个值</span><br><span class="line">            for (String colour : colours) &#123;</span><br><span class="line">                channel.queueBind(queueName, EXCHANGE_NAME, colour);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot; [RoutingRecv-&quot; + Arrays.toString(colours) + &quot;] Waiting for messages.&quot;);</span><br><span class="line">            // 定义消息的回调处理类</span><br><span class="line">            Consumer consumer = new DefaultConsumer(channel) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void handleDelivery(String consumerTag, Envelope envelope,</span><br><span class="line">                                           AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="line">                    String message = new String(body, &quot;UTF-8&quot;);</span><br><span class="line">                    System.out.println(&quot; [RoutingRecv-&quot; + Arrays.toString(colours) + &quot;] Received &apos;&quot; + envelope.getRoutingKey() + &quot;&apos;:&apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            // 接收消息</span><br><span class="line">            channel.basicConsume(queueName, true, consumer);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>测试：</p>
                    <ol>
                      <li>模拟上文中”单个绑定”的场景：</li>
                    </ol>
                    <p>BasicTest.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">@Test</span><br><span class="line">public void routing_1() throws InterruptedException &#123;</span><br><span class="line">    // 接收端 1：绑定 orange 值</span><br><span class="line">    executorService.submit(() -&gt; &#123;</span><br><span class="line">        String[] colours = &#123;&quot;orange&quot;&#125;;</span><br><span class="line">        RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">    &#125;);</span><br><span class="line">    // 接收端 2：绑定 black、green 值</span><br><span class="line">    executorService.submit(() -&gt; &#123;</span><br><span class="line">        String[] colours = &#123;&quot;black&quot;,&quot;green&quot;&#125;;</span><br><span class="line">        RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Thread.sleep(5* 100);</span><br><span class="line">    // 发送端1 ： 发送 black，只有接收端1收到</span><br><span class="line">    executorService.submit(() -&gt; &#123;</span><br><span class="line">        String routing = &quot;orange&quot;;</span><br><span class="line">        RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 发送端2 ： 发送 green、black，只有接收端2收到</span><br><span class="line">    executorService.submit(() -&gt; &#123;</span><br><span class="line">        String routing = &quot;green&quot;;</span><br><span class="line">        RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // sleep 10s</span><br><span class="line">    Thread.sleep(10 * 1000);</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>
                      以上代码启动2个消费者，消费者1绑定orange，消费者2绑定black、green;<br>启动2个生产者，生产者1发送消息的路由键为orange，此消息只被消费者1接收<br>生产者2发送消息的路由键为green，此消息只被消费者2接收，符合之前的分析
                    </p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">[RoutingRecv-[orange]] Waiting for messages.</span><br><span class="line">[RoutingSend] Sent &apos;orange&apos;:&apos;RoutingSend-1516003763435&apos;</span><br><span class="line">[RoutingSend] Sent &apos;green&apos;:&apos;RoutingSend-1516003763444&apos;</span><br><span class="line">// 生产者1发送消息的路由键为orange，此消息只被消费者1接收</span><br><span class="line">[RoutingRecv-[orange]] Received &apos;orange&apos;:&apos;RoutingSend-1516003763435&apos;</span><br><span class="line">// 生产者2发送消息的路由键为green，此消息只被消费者2接收</span><br><span class="line">[RoutingRecv-[black, green]] Waiting for messages.</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <ol start="2">
                      <li>模拟上文中”多个绑定”的场景</li>
                    </ol>
                    <p>BasicTest.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">@Test</span><br><span class="line">public void routing_2() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    // 接收端：同时创建两个接收端，同时绑定black</span><br><span class="line">    int recNum = 2;</span><br><span class="line">    while(recNum-- &gt; 0) &#123;</span><br><span class="line">         // 接收端：绑定 black 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;black&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Thread.sleep(5* 100);</span><br><span class="line">    // 发送端1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">    executorService.submit(() -&gt; &#123;</span><br><span class="line">        String routing = &quot;black&quot;;</span><br><span class="line">        RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 发送端2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">    executorService.submit(() -&gt; &#123;</span><br><span class="line">        String routing = &quot;green&quot;;</span><br><span class="line">        RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // sleep 10s</span><br><span class="line">    Thread.sleep(10 * 1000);</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>
                      以上代码启动2个消费者，都绑定black<br>启动2个生产者，生产者1发送消息的路由键为black，此消息被2个消费者都接收<br>生产者2发送消息的路由键为green，此消息被丢失，符合之前的分析
                    </p>
                    <p>测试输出如下:</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">[RoutingRecv-[black]] Waiting for messages.</span><br><span class="line">[RoutingRecv-[black]] Waiting for messages.</span><br><span class="line">// 生产者1发送消息的路由键为black，此消息被2个消费者都接收</span><br><span class="line">[RoutingSend] Sent &apos;black&apos;:&apos;RoutingSend-1516003663034&apos;</span><br><span class="line">[RoutingRecv-[black]] Received &apos;black&apos;:&apos;RoutingSend-1516003663034&apos;</span><br><span class="line">[RoutingRecv-[black]] Received &apos;black&apos;:&apos;RoutingSend-1516003663034&apos;</span><br><span class="line">// 生产者2发送消息的路由键为green，此消息被丢失</span><br><span class="line">[RoutingSend] Sent &apos;green&apos;:&apos;RoutingSend-1516003663045&apos;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>BasicTest.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic;</span><br><span class="line"></span><br><span class="line">import com.hry.spring.rabbitmq.basic.header.HeaderRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.header.HeaderSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.helloworld.HelloworldRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.helloworld.HelloworldSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.publishsubscribe.Publish;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.publishsubscribe.Subscribe;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.routing.RoutingRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.routing.RoutingSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.rpc.RpcClient;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.rpc.RpcServer;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.topics.TopicsRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.topics.TopicsSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.workqueues.WorkQueuesRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.workqueues.WorkQueuesSend;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by huangrongyou@yixin.im on 2018/1/10.</span><br><span class="line"> */</span><br><span class="line">public class BasicTest &#123;</span><br><span class="line">    // 测试线程池</span><br><span class="line">    private ExecutorService executorService = Executors.newFixedThreadPool(10);</span><br><span class="line"></span><br><span class="line">    // rabbitmq的IP地址</span><br><span class="line">    private final String rabbitmq_host = &quot;10.240.80.147&quot;;</span><br><span class="line">    // rabbitmq的用户名称</span><br><span class="line">    private final String rabbitmq_user = &quot;hry&quot;;</span><br><span class="line">    // rabbitmq的用户密码</span><br><span class="line">    private final String rabbitmq_pwd = &quot;hry&quot;;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void helloworld() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            HelloworldRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line"></span><br><span class="line">        // 发送端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            HelloworldSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void workqueues() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                WorkQueuesRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 4;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                WorkQueuesSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void publishsubscribe() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Subscribe.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 2;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Publish.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void routing_1() throws InterruptedException &#123;</span><br><span class="line">        // 接收端 1：绑定 orange 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;orange&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line">        // 接收端 2：绑定 black、green 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;black&quot;,&quot;green&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端 ： 发送 black，只有接收端1收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;orange&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 发送端 ： 发送 green、black，只有接收端2收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;green&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void routing_2() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 接收端：同时创建两个接收端，同时绑定black</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">             // 接收端：绑定 black 值</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                String[] colours = &#123;&quot;black&quot;&#125;;</span><br><span class="line">                RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;black&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 发送端2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;green&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void topics() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 消费者1：绑定 *.orange.* 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] bindingKeys = &#123;&quot;*.orange.*&quot;&#125;;</span><br><span class="line">            TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者2：绑定  &quot;*.*.rabbit&quot; 和 &quot;lazy.#&quot;值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] bindingKeys = &#123;&quot;*.*.rabbit&quot;, &quot;lazy.#&quot;&#125;;</span><br><span class="line">            TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 生产者1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;quick.orange.rabbit&quot;;</span><br><span class="line">            TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 生产者2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;lazy.pink.rabbit&quot;;</span><br><span class="line">            TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void rpc() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // rpc服务端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            RpcServer.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // rpc客户端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            RpcClient.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, &quot;rpc test&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void header() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 消费者1：绑定 format=pdf,type=report</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;report&quot;);</span><br><span class="line">            headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">            HeaderRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者2：绑定  format=pdf,type=log</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;log&quot;);</span><br><span class="line">            headers.put(&quot;x-match&quot;,&quot;any&quot;);</span><br><span class="line">            HeaderRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者3：绑定  format=zip,type=report</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;zip&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;report&quot;);</span><br><span class="line">            headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">         //   headers.put(&quot;x-match&quot;,&quot;any&quot;);</span><br><span class="line">            HeaderRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(2* 1000);</span><br><span class="line">        System.out.println(&quot;=============消息1===================&quot;);</span><br><span class="line">        // 生产者1 ： format=pdf,type=reprot,x-match=all</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;report&quot;);</span><br><span class="line">       //     headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">            HeaderSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        System.out.println(&quot;=============消息2===================&quot;);</span><br><span class="line">        // 生产者2 ： format=pdf,x-match=any</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">       //     headers.put(&quot;x-match&quot;,&quot;any&quot;);</span><br><span class="line">            HeaderSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        System.out.println(&quot;=============消息3===================&quot;);</span><br><span class="line">        // 生产者1 ： format=zip,type=log,x-match=all</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;zip&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;log&quot;);</span><br><span class="line">      //      headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">            HeaderSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p><strong>Fanout exchange（扇型交换机)</strong></p>
                    <p>扇型交换机（funout
                      exchange）将消息路由给绑定到它身上的所有队列。不同于直连交换机，路由键在此类型上不启任务作用。如果N个队列绑定到某个扇型交换机上，当有消息发送给此扇型交换机时，交换机会将消息的发送给这所有的N个队列<br>
                      目的： 实现生产者发送一个消息，这个消息同时被传送给所有消费者。<br>
                      <strong>生产者代码：</strong><br>Publish.java
                    </p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">1. 配置连接工厂</span><br><span class="line">2. 建立TCP连接</span><br><span class="line">3. 在TCP连接的基础上创建通道</span><br><span class="line">4. 声明一个fanout交换机 (而不是声明一个队列)</span><br><span class="line">5. 发送消息</span><br><span class="line">这里表明我们不使用默认交换机，在消费端需要执行队列和交换机的绑定操作</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>声明交换机方法：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">Exchange.DeclareOk exchangeDeclare(String exchange, String type, boolean durable, boolean autoDelete,</span><br><span class="line">                                       Map&lt;String, Object&gt; arguments) throws IOException</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>详细参数：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">第一个参数exchange：交换机的名称</span><br><span class="line">第二个参数type：交换机的类型</span><br><span class="line">第三个参数durable：是否持久化，如果true，则当前RabbitMQ重启的时候，它依旧存在</span><br><span class="line">第四个参数autoDelete：当没有生成者/消费者使用此交换机时，此交换机会被自动删除。</span><br><span class="line">第五个参数arguments：其它的扩展属性</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>代码如下：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">// 声明一个fanout交换机</span><br><span class="line">channel.exchangeDeclare(EXCHANGE_NAME,BuiltinExchangeType.FANOUT, false, false, null);</span><br><span class="line">// 发送消息</span><br><span class="line">channel.basicPublish(EXCHANGE_NAME, &quot;&quot;, null, message.getBytes(&quot;UTF-8&quot;));</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>Publish.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.publishsubscribe;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line">import com.rabbitmq.client.ConnectionFactory;</span><br><span class="line">import com.rabbitmq.client.Connection;</span><br><span class="line">import com.rabbitmq.client.Channel;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.concurrent.TimeoutException;</span><br><span class="line"></span><br><span class="line">public class Publish &#123;</span><br><span class="line">    private static final String EXCHANGE_NAME = &quot;logs&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password) &#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line">        Connection connection = null;</span><br><span class="line">        Channel channel = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            // 声明一个fanout交换机</span><br><span class="line">           // channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME,BuiltinExchangeType.FANOUT, false, false, null);</span><br><span class="line">            String message = &quot;Publish-&quot; + System.nanoTime();</span><br><span class="line">            // 发送消息</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, &quot;&quot;, null, message.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">            System.out.println(&quot; [Publish] Sent &apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                // 空值判断，为了代码简洁略</span><br><span class="line">                channel.close();</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>消费者代码：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">1. 配置连接工厂</span><br><span class="line">2. 建立TCP连接</span><br><span class="line">3. 在TCP连接的基础上创建通道</span><br><span class="line">4. 声明一个fanout交换机 </span><br><span class="line">5. 声明一个临时队列</span><br><span class="line">6. 将临时队列绑定到交换机上</span><br><span class="line">7. 接收消息并处理</span><br><span class="line">这里表明我们不使用默认交换机，在消费端需要执行队列和交换机的绑定操作</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>临时队列：<br>在本例子中，我们使用临时队列。临时队列有以下特点：</p>
                    <ol>
                      <li>消费者每次连接时，都会创建一个新的队列，队列名称随机生成</li>
                      <li>当消费者断开连接时，队列会自动变删除</li>
                    </ol>
                    <p>在RabbitMQ中，随机使用的队列名称类似amq.gen-**</p>
                    <p>声明方法:</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">Queue.DeclareOk queueDeclare() throws IOException;  </span><br><span class="line"></span><br><span class="line">此方法等价于创建一个</span><br><span class="line">Queue.DeclareOk queueDeclare(String queue=&quot;自动生成类似amq.gen-******的随机名称&quot;, boolean durable=false, boolean exclusive=true, boolean autoDelete=true,  Map&lt;String, Object&gt; arguments=null) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>代码：创建临时队列，得到队列名称，用于后面的绑定使用</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">String queueName = channel.queueDeclare().getQueue();</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>
                      <strong>绑定(Bindings)</strong><br>在创建交换机、队列后，要实现将发送到特定的交换机X的消息路由到我们创建的队列，还需要做绑定操作。如果绑定成功后，交换机会将带特定路由键的消息路由到绑定的队列<br>方法：将队列绑定到交换机上
                    </p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">Queue.BindOk queueBind(String queue, String exchange, String routingKey) throws IOException;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>详细参数如下：</p>
                    <pre><code>第一个参数queue：要绑定的队列
第二个参数exchange：要绑定的交换机
第三个参数routingKey：绑定使用的路由键</code></pre>
                    <p>
                      代码：将队列绑定到交换机上，因为我们这个demo是使用扇形交换机，routingKey是没有意义的，所以这里使用的routingKey为空字符串
                    </p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">String queueName = channel.queueDeclare().getQueue();</span><br><span class="line">channel.queueBind(queueName, EXCHANGE_NAME, &quot;&quot;);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>Subscribe.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.publishsubscribe;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Subscribe &#123;</span><br><span class="line">    private static final String EXCHANGE_NAME = &quot;logs&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password, int id)&#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">            // 声明一个fanout交换机</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);</span><br><span class="line">            // 声明一个临时队列</span><br><span class="line">            String queueName = channel.queueDeclare().getQueue();</span><br><span class="line">            // 将临时队列绑定到交换机上</span><br><span class="line">            channel.queueBind(queueName, EXCHANGE_NAME, &quot;&quot;);</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot; [Subscribe-&quot;+id+&quot;] Waiting for messages.&quot;);</span><br><span class="line"></span><br><span class="line">            Consumer consumer = new DefaultConsumer(channel) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void handleDelivery(String consumerTag, Envelope envelope,</span><br><span class="line">                                           AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="line">                    String message = new String(body, &quot;UTF-8&quot;);</span><br><span class="line">                    System.out.println(&quot; [Subscribe-&quot;+id+&quot;] Received &apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            // 接收消费消息</span><br><span class="line">            channel.basicConsume(queueName, true, consumer);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>测试代码：</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">public class BasicTest &#123;</span><br><span class="line">    // 测试线程池</span><br><span class="line">    private ExecutorService executorService = Executors.newFixedThreadPool(10);</span><br><span class="line"></span><br><span class="line">    // rabbitmq的IP地址</span><br><span class="line">    private final String rabbitmq_host = &quot;10.240.80.147&quot;;</span><br><span class="line">    // rabbitmq的用户名称</span><br><span class="line">    private final String rabbitmq_user = &quot;hry&quot;;</span><br><span class="line">    // rabbitmq的用户密码</span><br><span class="line">    private final String rabbitmq_pwd = &quot;hry&quot;;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void publishsubscribe() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Subscribe.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 2;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Publish.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>执行测试，启动两个消费者，发送者发送2条记录，这些记录同时被2个消费者消费:</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">[Subscribe-0] Waiting for messages.</span><br><span class="line">[Subscribe-1] Waiting for messages.</span><br><span class="line">// 发送两条记录</span><br><span class="line">[Publish] Sent &apos;Publish-366028801770803&apos;</span><br><span class="line">[Publish] Sent &apos;Publish-366028803809517&apos;</span><br><span class="line">// 消费者1收到两条记录</span><br><span class="line">[Subscribe-0] Received &apos;Publish-366028801770803&apos;</span><br><span class="line">[Subscribe-0] Received &apos;Publish-366028803809517&apos;</span><br><span class="line">// 消费者2收到两条记录</span><br><span class="line">[Subscribe-1] Received &apos;Publish-366028801770803&apos;</span><br><span class="line">[Subscribe-1] Received &apos;Publish-366028803809517&apos;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p><strong>Topic exchange（主题交换机）</strong></p>
                    <p>主题交换机（topic
                      exchanges）中，队列通过路由键绑定到交换机上，然后，交换机根据消息里的路由值，将消息路由给一个或多个绑定队列。
                    </p>
                    <p>扇型交换机和主题交换机异同：</p>
                    <pre><code>对于扇型交换机路由键是没有意义的，只要有消息，它都发送到它绑定的所有队列上
对于主题交换机，路由规则由路由键决定，只有满足路由键的规则，消息才可以路由到对应的队列上</code></pre>
                    <p>我们通过direct
                      exchange（直连交换机）可以根据路由键进行路由，但是还是不够灵活，它只能进行完全匹配。这节我们引入Topic
                      exchange(主题交换机)，支持对路由键的模糊匹配<br>上篇文章实现生产者发送一个消息，这个消息同时被传送给所有队列。但是有时我们不希望所有的消息都被所有队列接收，我们希望可以指定类型为a的消息只能被队列A接收，类型为b的消息只能被队列B,C接收。扇型交换机只能无脑地广播消息给所有的消费者，实质是广播给所有关联的队列。<br>为了实现这个功能，一种是建立多个交换机，这种方式简单暴力但是不灵活。本节我们介绍使用单个直连交换机+路由实现以上功能
                    </p>
                    <p>路由键中特殊匹配字符说明</p>
                    <pre><code>*（星号）可以代替一个字。
＃（散列）可以代替零个或多个单词。</code></pre>
                    <p>Topic Exchange的路由键条件：</p>
                    <pre><code>必须是由英文单词列表组成，单词之间使用”.”分隔
路由键的长度最大255字节

生产者代码</code></pre>
                    <p>主要业务逻辑如下：</p>
                    <ol>
                      <li>配置连接工厂</li>
                      <li>建立TCP连接</li>
                      <li>在TCP连接的基础上创建通道</li>
                      <li>声明一个topic交换机 </li>
                      <li>发送消息，并配置消息的路由键</li>
                    </ol>
                    <p>此代码和上一篇的代码基本相同，最大的不同是声明了topic交换机</p>
                    <p>// 声明一个topic交换机</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>TopicsSend.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.topics;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.BuiltinExchangeType;</span><br><span class="line">import com.rabbitmq.client.ConnectionFactory;</span><br><span class="line">import com.rabbitmq.client.Connection;</span><br><span class="line">import com.rabbitmq.client.Channel;</span><br><span class="line"></span><br><span class="line">public class TopicsSend &#123;</span><br><span class="line">    private static final String EXCHANGE_NAME = &quot;topic_logs&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password, String routingKey) &#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line"></span><br><span class="line">        Connection connection = null;</span><br><span class="line">        Channel channel = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            // 声明一个topic交换机</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line">            String message = &quot;Topics-&quot; + System.currentTimeMillis();</span><br><span class="line">            // 发送消息，并配置消息的路由键</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, routingKey, null, message.getBytes(&quot;UTF-8&quot;));</span><br><span class="line">            System.out.println(&quot; [HeaderSend] Sent &apos;&quot; + routingKey + &quot;&apos;:&apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        catch  (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        finally &#123;</span><br><span class="line">            if (connection != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception ignore) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static String getRouting(String[] strings)&#123;</span><br><span class="line">        if (strings.length &lt; 1)</span><br><span class="line">            return &quot;anonymous.info&quot;;</span><br><span class="line">        return strings[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static String getMessage(String[] strings)&#123;</span><br><span class="line">        if (strings.length &lt; 2)</span><br><span class="line">            return &quot;Hello World!&quot;;</span><br><span class="line">        return joinStrings(strings, &quot; &quot;, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static String joinStrings(String[] strings, String delimiter, int startIndex) &#123;</span><br><span class="line">        int length = strings.length;</span><br><span class="line">        if (length == 0 ) return &quot;&quot;;</span><br><span class="line">        if (length &lt; startIndex ) return &quot;&quot;;</span><br><span class="line">        StringBuilder words = new StringBuilder(strings[startIndex]);</span><br><span class="line">        for (int i = startIndex + 1; i &lt; length; i++) &#123;</span><br><span class="line">            words.append(delimiter).append(strings[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return words.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>接收者代码</p>
                    <p>主要业务逻辑如下：</p>
                    <ol>
                      <li>配置连接工厂</li>
                      <li>建立TCP连接</li>
                      <li>在TCP连接的基础上创建通道</li>
                      <li>声明一个topic交换机 </li>
                      <li>声明一个临时队列</li>
                      <li>将临时队列绑定到交换机上，并在队列上绑定多个绑定值</li>
                      <li>接收消息并处理</li>
                    </ol>
                    <p>此代码和上一篇的代码基本相同，最大的不同是声明了topic交换机</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">// 声明一个topic交换机</span><br><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>TopicsRecv.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic.topics;</span><br><span class="line"></span><br><span class="line">import com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public class TopicsRecv &#123;</span><br><span class="line">    private static final String EXCHANGE_NAME = &quot;topic_logs&quot;;</span><br><span class="line"></span><br><span class="line">    public static void execute(String host, String userName, String password, String[] bindingKeys)&#123;</span><br><span class="line">        // 配置连接工厂</span><br><span class="line">        ConnectionFactory factory = new ConnectionFactory();</span><br><span class="line">        factory.setHost(host);</span><br><span class="line">        // 需要在管理后台增加一个hry帐号</span><br><span class="line">        factory.setUsername(userName);</span><br><span class="line">        factory.setPassword(password);</span><br><span class="line"></span><br><span class="line">        Connection connection = null;</span><br><span class="line">        Channel channel = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 建立TCP连接</span><br><span class="line">            connection = factory.newConnection();</span><br><span class="line">            // 在TCP连接的基础上创建通道</span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            // 声明一个topic交换机</span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line">            // 声明一个临时队列</span><br><span class="line">            String queueName = channel.queueDeclare().getQueue();</span><br><span class="line">            // 绑定路由，同一个队列可以绑定多个值</span><br><span class="line">            for (String bindingKey : bindingKeys) &#123;</span><br><span class="line">                channel.queueBind(queueName, EXCHANGE_NAME, bindingKey);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot; [HeaderRecv &quot;+ Arrays.toString(bindingKeys)+&quot;] Waiting for messages.&quot;);</span><br><span class="line"></span><br><span class="line">            Consumer consumer = new DefaultConsumer(channel) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void handleDelivery(String consumerTag, Envelope envelope,</span><br><span class="line">                                           AMQP.BasicProperties properties, byte[] body) throws IOException &#123;</span><br><span class="line">                    String message = new String(body, &quot;UTF-8&quot;);</span><br><span class="line">                    System.out.println(&quot; [HeaderRecv &quot;+ Arrays.toString(bindingKeys) + &quot; ] Received &apos;&quot; + envelope.getRoutingKey() + &quot;&apos;:&apos;&quot; + message + &quot;&apos;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            // 接收消息</span><br><span class="line">            channel.basicConsume(queueName, true, consumer);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p><strong>测试</strong><br>BasicTest</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">@Test</span><br><span class="line">public void topics() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">   // 消费者1：绑定 *.orange.* 值</span><br><span class="line">   executorService.submit(() -&gt; &#123;</span><br><span class="line">       String[] bindingKeys = &#123;&quot;*.orange.*&quot;&#125;;</span><br><span class="line">       TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   // 消费者2：绑定  &quot;*.*.rabbit&quot; 和 &quot;lazy.#&quot;值</span><br><span class="line">   executorService.submit(() -&gt; &#123;</span><br><span class="line">       String[] bindingKeys = &#123;&quot;*.*.rabbit&quot;, &quot;lazy.#&quot;&#125;;</span><br><span class="line">       TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   Thread.sleep(5* 100);</span><br><span class="line">   // 生产者1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">   executorService.submit(() -&gt; &#123;</span><br><span class="line">       String routing = &quot;quick.orange.rabbit&quot;;</span><br><span class="line">       TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   // 生产者2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">   executorService.submit(() -&gt; &#123;</span><br><span class="line">       String routing = &quot;lazy.pink.rabbit&quot;;</span><br><span class="line">       TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   // sleep 10s</span><br><span class="line">   Thread.sleep(10 * 1000);</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>以上代码启动2个消费者，消费者1绑定”<em>.orange.</em>”
                      ，消费者2个绑定”<em>.</em>.rabbit” 和
                      “lazy.#”;<br>启动2个生产者，生产者1发送消息的路由键为
                      “quick.orange.rabbit”，此消息同时被2个消费者接收<br>生产者2发送消息的路由键为”lazy.pink.rabbit”，此消息只被消费者2接收，符合之前的分析
                    </p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">// 启动2个消费者，消费者1绑定&quot;*.orange.*&quot; ，消费者2个绑定&quot;*.*.rabbit&quot; 和 &quot;lazy.#&quot;</span><br><span class="line">[TopicsRecv [*.orange.*]] Waiting for messages.</span><br><span class="line">[TopicsRecv [*.*.rabbit, lazy.#]] Waiting for messages.</span><br><span class="line">// 生产者1发送消息的路由键为 &quot;quick.orange.rabbit&quot;，此消息同时被2个消费者接收</span><br><span class="line">[TopicsSend] Sent &apos;quick.orange.rabbit&apos;:&apos;Topics-1516008766983&apos;</span><br><span class="line">[TopicsRecv [*.*.rabbit, lazy.#] ] Received &apos;quick.orange.rabbit&apos;:&apos;Topics-1516008766983&apos;</span><br><span class="line">[TopicsRecv [*.orange.*] ] Received &apos;quick.orange.rabbit&apos;:&apos;Topics-1516008766983&apos;</span><br><span class="line">// 生产者2发送消息的路由键为&quot;lazy.pink.rabbit&quot;，此消息只被消费者2接收</span><br><span class="line">[TopicsSend] Sent &apos;lazy.pink.rabbit&apos;:&apos;Topics-1516008767012&apos;</span><br><span class="line">[TopicsRecv [*.*.rabbit, lazy.#] ] Received &apos;lazy.pink.rabbit&apos;:&apos;Topics-1516008767012&apos;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p>BasicTest.java</p>
                    <figure class="highlight plain">
                      <table>
                        <tr>
                          <td class="gutter">
                            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre>
                          </td>
                          <td class="code">
                            <pre><span class="line">package com.hry.spring.rabbitmq.basic;</span><br><span class="line"></span><br><span class="line">import com.hry.spring.rabbitmq.basic.header.HeaderRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.header.HeaderSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.helloworld.HelloworldRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.helloworld.HelloworldSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.publishsubscribe.Publish;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.publishsubscribe.Subscribe;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.routing.RoutingRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.routing.RoutingSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.rpc.RpcClient;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.rpc.RpcServer;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.topics.TopicsRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.topics.TopicsSend;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.workqueues.WorkQueuesRecv;</span><br><span class="line">import com.hry.spring.rabbitmq.basic.workqueues.WorkQueuesSend;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by huangrongyou@yixin.im on 2018/1/10.</span><br><span class="line"> */</span><br><span class="line">public class BasicTest &#123;</span><br><span class="line">    // 测试线程池</span><br><span class="line">    private ExecutorService executorService = Executors.newFixedThreadPool(10);</span><br><span class="line"></span><br><span class="line">    // rabbitmq的IP地址</span><br><span class="line">    private final String rabbitmq_host = &quot;10.240.80.147&quot;;</span><br><span class="line">    // rabbitmq的用户名称</span><br><span class="line">    private final String rabbitmq_user = &quot;hry&quot;;</span><br><span class="line">    // rabbitmq的用户密码</span><br><span class="line">    private final String rabbitmq_pwd = &quot;hry&quot;;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void helloworld() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            HelloworldRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line"></span><br><span class="line">        // 发送端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            HelloworldSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void workqueues() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                WorkQueuesRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 4;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                WorkQueuesSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void publishsubscribe() throws InterruptedException &#123;</span><br><span class="line">        // 接收端</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">            final int recId = recNum;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Subscribe.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, recId);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端</span><br><span class="line">        int sendNum = 2;</span><br><span class="line">        while(sendNum-- &gt; 0)&#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                Publish.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void routing_1() throws InterruptedException &#123;</span><br><span class="line">        // 接收端 1：绑定 orange 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;orange&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line">        // 接收端 2：绑定 black、green 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] colours = &#123;&quot;black&quot;,&quot;green&quot;&#125;;</span><br><span class="line">            RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端 ： 发送 black，只有接收端1收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;orange&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 发送端 ： 发送 green、black，只有接收端2收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;green&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void routing_2() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 接收端：同时创建两个接收端，同时绑定black</span><br><span class="line">        int recNum = 2;</span><br><span class="line">        while(recNum-- &gt; 0) &#123;</span><br><span class="line">             // 接收端：绑定 black 值</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                String[] colours = &#123;&quot;black&quot;&#125;;</span><br><span class="line">                RoutingRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, colours);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 发送端1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;black&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 发送端2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;green&quot;;</span><br><span class="line">            RoutingSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void topics() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 消费者1：绑定 *.orange.* 值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] bindingKeys = &#123;&quot;*.orange.*&quot;&#125;;</span><br><span class="line">            TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者2：绑定  &quot;*.*.rabbit&quot; 和 &quot;lazy.#&quot;值</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String[] bindingKeys = &#123;&quot;*.*.rabbit&quot;, &quot;lazy.#&quot;&#125;;</span><br><span class="line">            TopicsRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, bindingKeys);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        // 生产者1 ： 发送 black，所有的接收端都会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;quick.orange.rabbit&quot;;</span><br><span class="line">            TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 生产者2 ： 发送 green，所有的接收端都不会收到</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            String routing = &quot;lazy.pink.rabbit&quot;;</span><br><span class="line">            TopicsSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, routing);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void rpc() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // rpc服务端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            RpcServer.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // rpc客户端</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            RpcClient.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, &quot;rpc test&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void header() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        // 消费者1：绑定 format=pdf,type=report</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;report&quot;);</span><br><span class="line">            headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">            HeaderRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者2：绑定  format=pdf,type=log</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;log&quot;);</span><br><span class="line">            headers.put(&quot;x-match&quot;,&quot;any&quot;);</span><br><span class="line">            HeaderRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // 消费者3：绑定  format=zip,type=report</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;zip&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;report&quot;);</span><br><span class="line">            headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">         //   headers.put(&quot;x-match&quot;,&quot;any&quot;);</span><br><span class="line">            HeaderRecv.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(2* 1000);</span><br><span class="line">        System.out.println(&quot;=============消息1===================&quot;);</span><br><span class="line">        // 生产者1 ： format=pdf,type=reprot,x-match=all</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;report&quot;);</span><br><span class="line">       //     headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">            HeaderSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        System.out.println(&quot;=============消息2===================&quot;);</span><br><span class="line">        // 生产者2 ： format=pdf,x-match=any</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;pdf&quot;);</span><br><span class="line">       //     headers.put(&quot;x-match&quot;,&quot;any&quot;);</span><br><span class="line">            HeaderSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(5* 100);</span><br><span class="line">        System.out.println(&quot;=============消息3===================&quot;);</span><br><span class="line">        // 生产者1 ： format=zip,type=log,x-match=all</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            Map&lt;String,Object&gt; headers = new HashMap();</span><br><span class="line">            headers.put(&quot;format&quot;,&quot;zip&quot;);</span><br><span class="line">            headers.put(&quot;type&quot;,&quot;log&quot;);</span><br><span class="line">      //      headers.put(&quot;x-match&quot;,&quot;all&quot;);</span><br><span class="line">            HeaderSend.execute(rabbitmq_host, rabbitmq_user, rabbitmq_pwd, headers);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        // sleep 10s</span><br><span class="line">        Thread.sleep(10 * 1000);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                          </td>
                        </tr>
                      </table>
                    </figure>

                    <p><strong>Headers exchange)(头交换机)</strong></p>
                    <p>
                      类似主题交换机，但是头交换机使用多个消息属性来代替路由键建立路由规则。通过判断消息头的值能否与指定的绑定相匹配来确立路由规则。<br>此交换机有个重要参数：”x-match”
                    </p>
                    <pre><code>当”x-match”为“any”时，消息头的任意一个值被匹配就可以满足条件
当”x-match”设置为“all”的时候，就需要消息头的所有值都匹配成功</code></pre>
                    <p>RabbitMQ默认定义一些交换机</p>
                    <p>在RabbitMQ默认定义一些交换机，主要如下：</p>
                    <p><strong>默认交换机</strong><br>默认交换机（default
                      exchange）实际上是一个由RabbitMQ预先声明好的名字为空字符串的直连交换机（direct
                      exchange）。它有一个特殊的属性使得它对于简单应用特别有用处：那就是每个新建队列（queue）都会自动绑定到默认交换机上，绑定的路由键（routing
                      key）名称与队列名称相同。</p>
                    <p>
                      如：当你声明了一个名为”hello”的队列，RabbitMQ会自动将其绑定到默认交换机上，绑定（binding）的路由键名称也是为”hello”。因此，当携带着名为”hello”的路由键的消息被发送到默认交换机的时候，此消息会被默认交换机路由至名为”hello”的队列中。即默认交换机看起来貌似能够直接将消息投递给队列.<br><strong>Dead
                        Letter Exchange（死信交换机）</strong></p>
                    <p>
                      在默认情况，如果消息在投递到交换机时，交换机发现此消息没有匹配的队列，则这个消息将被悄悄丢弃。为了解决这个问题，RabbitMQ中有一种交换机叫死信交换机。当消费者不能处理接收到的消息时，将这个消息重新发布到另外一个队列中，等待重试或者人工干预。这个过程中的exchange和queue就是所谓的”Dead
                      Letter Exchange 和 Queue”</p>
                    <p><strong>交换机的属性</strong></p>
                    <p>除交换机类型外，在声明交换机时还可以附带许多其他的属性，其中最重要的几个分别是：</p>
                    <pre><code>Name：交换机名称
Durability：是否持久化。如果持久性，则RabbitMQ重启后，交换机还存在
Auto-delete：当所有与之绑定的消息队列都完成了对此交换机的使用后，删掉它
Arguments：扩展参数</code></pre>

                  </div>
                  <div>

                    <div>

                      <div
                                                                                                      style="text-align:center;color: #ccc;font-size:14px;">
                        -------------本文结束<i
                                                                                                        class="fa fa-paw"></i>感谢您的阅读-------------
                      </div>

                    </div>

                  </div>

                  <div>

                  </div>

                  <div>
                    <div
                                                                                                    style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                      <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
                      <button id="rewardButton" disable="enable"
                                                                                                      onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                        <span>打赏</span>
                      </button>
                      <div id="QR" style="display: none;">

                        <div id="wechat" style="display: inline-block">
                          <img id="wechat_qr" src="/images/wechatpay.jpg"
                                                                                                          alt="stardust 微信支付">
                          <p>微信支付</p>
                        </div>

                        <div id="alipay" style="display: inline-block">
                          <img id="alipay_qr" src="/images/alipay.jpg"
                                                                                                          alt="stardust 支付宝">
                          <p>支付宝</p>
                        </div>

                      </div>
                    </div>

                  </div>

                  <div>
                    <ul class="post-copyright">
                      <li class="post-copyright-author">
                        <strong>本文作者：</strong>
                        stardust
                      </li>
                      <li class="post-copyright-link">
                        <strong>本文链接：</strong>
                        <a href="http://javastar.club/archives/efd55b48.html"
                                                                                                        title="消息中间件之RabbitMq学习">http://javastar.club/archives/efd55b48.html</a>
                      </li>
                      <li class="post-copyright-license">
                        <strong>版权声明： </strong>
                        本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow noopener noreferrer"
                                                                                                        target="_blank">CC
                          BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
                      </li>
                    </ul>

                  </div>

                  <footer class="post-footer">

                    <div class="post-tags">

                      <a href="/tags/RabbitMQ/" rel="tag"># RabbitMQ</a>

                    </div>

                    <div class="post-nav">
                      <div class="post-nav-next post-nav-item">

                        <a href="/archives/a36562d7.html" rel="next"
                                                                                                        title="MongoDB学习笔记">
                          <i class="fa fa-chevron-left"></i> MongoDB学习笔记
                        </a>

                      </div>

                      <span class="post-nav-divider"></span>

                      <div class="post-nav-prev post-nav-item">

                        <a href="/archives/ca103a9f.html" rel="prev"
                                                                                                        title="spring boot学习第二次">
                          spring boot学习第二次 <i class="fa fa-chevron-right"></i>
                        </a>

                      </div>
                    </div>

                  </footer>
                </div>

              </article>

              <div class="post-spread">

              </div>
            </div>

          </div>

          <div class="comments" id="comments">
          </div>

        </div>

        <div class="sidebar-toggle">
          <div class="sidebar-toggle-line-wrap">
            <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
            <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
            <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
          </div>
        </div>

        <aside id="sidebar" class="sidebar">

          <div class="sidebar-inner">

            <ul class="sidebar-nav motion-element">
              <li class="sidebar-nav-toc sidebar-nav-active"
                                                                                              data-target="post-toc-wrap">
                文章目录
              </li>
              <li class="sidebar-nav-overview" data-target="site-overview-wrap">
                站点概览
              </li>
            </ul>

            <section class="site-overview-wrap sidebar-panel">
              <div class="site-overview">
                <div class="site-author motion-element" itemprop="author" itemscope
                                                                                                itemtype="http://schema.org/Person">

                  <img class="site-author-image" itemprop="image" src="/images/head.jpg"
                                                                                                  alt="stardust">

                  <p class="site-author-name" itemprop="name">stardust</p>
                  <p class="site-description motion-element"
                                                                                                  itemprop="description">
                    个人技术博客</p>
                </div>

                <nav class="site-state motion-element">

                  <div class="site-state-item site-state-posts">

                    <a href="/archives/">

                      <span class="site-state-item-count">87</span>
                      <span class="site-state-item-name">日志</span>
                    </a>
                  </div>

                  <div class="site-state-item site-state-categories">
                    <a href="/categories/index.html">
                      <span class="site-state-item-count">54</span>
                      <span class="site-state-item-name">分类</span>
                    </a>
                  </div>

                  <div class="site-state-item site-state-tags">

                    <span class="site-state-item-count">61</span>
                    <span class="site-state-item-name">标签</span>

                  </div>

                </nav>

                <div class="feed-link motion-element">
                  <a href="/atom.xml" rel="alternate">
                    <i class="fa fa-rss"></i>
                    RSS
                  </a>
                </div>

                -
                <div id="days"></div>
                <script>
                  function show_date_time() {
                    window.setTimeout("show_date_time()"，
                      1000);
                    BirthDay = new Date("06/27/2019 15:13:14");
                    today = new Date();
                    timeold = (today.getTime() - BirthDay.getTime());
                    sectimeold = timeold / 1000
                    secondsold = Math.floor(sectimeold);
                    msPerDay = 24 * 60 * 60 * 1000
                    e_daysold = timeold / msPerDay
                    daysold = Math.floor(e_daysold);
                    e_hrsold = (e_daysold - daysold) * 24;
                    hrsold = setzero(Math.floor(e_hrsold));
                    e_minsold = (e_hrsold - hrsold) * 60;
                    minsold = setzero(Math.floor((e_hrsold - hrsold) * 60));
                    seconds = setzero(Math.floor((e_minsold - minsold) * 60));
                    document.getElementById('days').innerHTML = "已运行" +
                      daysold + "天" + hrsold + "小时" + minsold + "分" + seconds +
                      "秒";
                  }

                  function setzero(i) {
                    if (i < 10) {
                      i = "0" + i
                    };
                    return i;
                  }
                  show_date_time();

                </script>

              </div>
            </section>

            <!--noindex-->
            <section
                                                                                            class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
              <div class="post-toc">

                <div class="post-toc-content">
                  <ol class="nav">
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#RabbitMQ简介"><span
                                                                                                        class="nav-number">1.</span>
                        <span class="nav-text">RabbitMQ简介
                        </span></a></li>
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#消息队列"><span
                                                                                                        class="nav-number">2.</span>
                        <span class="nav-text">消息队列</span></a></li>
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#RabbitMQ特点"><span
                                                                                                        class="nav-number">3.</span>
                        <span class="nav-text">RabbitMQ特点
                        </span></a></li>
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#RabbitMQ中的概念模型–消息模型"><span
                                                                                                        class="nav-number">4.</span>
                        <span class="nav-text">RabbitMQ中的概念模型–消息模型
                        </span></a></li>
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#RabbitMQ基本概念"><span
                                                                                                        class="nav-number">5.</span>
                        <span class="nav-text">RabbitMQ基本概念
                        </span></a></li>
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#RabbitMQ消息持久性、确认机制、拒绝、预取数量、分配策略"><span
                                                                                                        class="nav-number">6.</span>
                        <span class="nav-text">RabbitMQ消息持久性、确认机制、拒绝、预取数量、分配策略
                        </span></a></li>
                    <li class="nav-item nav-level-3"><a class="nav-link"
                                                                                                      href="#RabbitMQ之交换机的四种类型和属性"><span
                                                                                                        class="nav-number">7.</span>
                        <span class="nav-text">RabbitMQ之交换机的四种类型和属性
                        </span></a></li>
                  </ol>
                </div>

              </div>
            </section>
            <!--/noindex-->

          </div>
        </aside>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
          <span class="with-love">
            <i class="fa fa-[object Object]"></i>
          </span>
          <span class="author" itemprop="copyrightHolder">stardust</span>

          <span class="post-meta-divider">|</span>
          <span class="post-meta-item-icon">
            <i class="fa fa-area-chart"></i>
          </span>

          <span class="post-meta-item-text">Site words total count&#58;</span>

          <span title="Site words total count">227.5k</span>

        </div>

        <script async
                                                                                        src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
        </script>
        <span id="busuanzi_container_site_pv">本站总访问量<span
                                                                                          id="busuanzi_value_site_pv"></span>次</span>
        <span id="busuanzi_container_site_uv">
          本站访客数<span id="busuanzi_value_site_uv"></span>人次
        </span>

        <div class="busuanzi-count">
          <script async
                                                                                          src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
          </script>

        </div>

      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>

    </div>

  </div>

  <script type="text/javascript">
    if (Object.prototype.toString.call(window.Promise) !==
      '[object Function]') {
      window.Promise = null;
    }

  </script>

  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript"
                                                                                  src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6">
  </script>

  <script type="text/javascript"
                                                                                  src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7">
  </script>

  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1">
  </script>

  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1">
  </script>

  <script type="text/javascript"
                                                                                  src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5">
  </script>

  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4">
  </script>

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>

  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>

  <script type="text/javascript">
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.indexOf(item) > -1;
    });
    new Valine({
      el: '#comments',
      verify: true,
      notify: true,
      appId: 'SC04XqdJGidywEU8kpDnXmu6-MdYXbMMI',
      appKey: 'WWH572JLnQB3A4r74XKMGOok',
      placeholder: '来评论下呗',
      avatar: 'mm',
      guest_info: guest,
      pageSize: '10' || 10,
    });

  </script>

  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>
    AV.initialize("SC04XqdJGidywEU8kpDnXmu6-MdYXbMMI",
      "WWH572JLnQB3A4r74XKMGOok");

  </script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");
      $visitors.each(function() {
        entries.push($(this).attr("id").trim());
      });
      query.containedIn('url', entries);
      query.find()
        .done(function(results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }
          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);
            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function(object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);
      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(
                  counter.get('time'));
              },
              error: function(counter, error) {
                console.log(
                  'Failed to save Visitor num, with error message: ' +
                  error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(
                  newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }
    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });

  </script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":70,"height":120},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
<script type="text/javascript" src="/js/src/dytitle.js"></script>
